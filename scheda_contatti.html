<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contatti</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Contatti</h1>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
    </div>

    <form id="contattiForm" class="space-y-6">
      <section>
        <h2 class="text-lg font-semibold mb-2">Genitore 1</h2>
        <div class="mb-2">
          <label class="block font-semibold" for="genitore1_nome">Nome</label>
          <input type="text" id="genitore1_nome" name="genitore1_nome" class="w-full p-2 border rounded" />
        </div>
        <div class="mb-2 flex items-center gap-2">
          <input type="email" id="genitore1_email" name="genitore1_email" class="flex-grow p-2 border rounded" placeholder="Email" />
          <button type="button" id="gen1_email_write_btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" title="Scrivi email">ðŸ“§</button>
        </div>
        <div class="mb-2 flex items-center gap-2">
          <label class="block font-semibold flex-grow" for="genitore1_telefono">Telefono</label>
          <input type="tel" id="genitore1_telefono" name="genitore1_telefono" class="flex-grow p-2 border rounded" />
          <button type="button" id="gen1_phone_btn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" title="Chiama">ðŸ“ž</button>
          <button type="button" id="gen1_whatsapp_btn" class="bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800" title="WhatsApp">ðŸŸ¢</button>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2">Genitore 2</h2>
        <div class="mb-2">
          <input type="text" id="genitore2_nome" name="genitore2_nome" class="w-full p-2 border rounded" placeholder="Nome" />
        </div>
        <div class="mb-2 flex items-center gap-2">
          <input type="email" id="genitore2_email" name="genitore2_email" class="flex-grow p-2 border rounded" placeholder="Email" />
          <button type="button" id="gen2_email_write_btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" title="Scrivi email">ðŸ“§</button>
        </div>
        <div class="mb-2 flex items-center gap-2">
          <input type="tel" id="genitore2_telefono" name="genitore2_telefono" class="flex-grow p-2 border rounded" />
          <button type="button" id="gen2_phone_btn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" title="Chiama">ðŸ“ž</button>
          <button type="button" id="gen2_whatsapp_btn" class="bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800" title="WhatsApp">ðŸŸ¢</button>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold mb-2">Esploratore</h2>
        <div class="mb-2 flex items-center gap-2">
          <input type="email" id="esploratore_email" name="esploratore_email" class="flex-grow p-2 border rounded" placeholder="Email" />
          <button type="button" id="expl_email_write_btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" title="Scrivi email">ðŸ“§</button>
        </div>
        <div class="mb-2 flex items-center gap-2">
          <input type="tel" id="esploratore_telefono" name="esploratore_telefono" class="flex-grow p-2 border rounded" />
          <button type="button" id="expl_phone_btn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" title="Chiama">ðŸ“ž</button>
          <button type="button" id="expl_whatsapp_btn" class="bg-green-700 text-white px-3 py-1 rounded hover:bg-green-800" title="WhatsApp">ðŸŸ¢</button>
        </div>
      </section>

      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Salva</button>
    </form>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { db } from './firebaseConfig.js';
    import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const auth = getAuth();

    const logoutBtn = document.getElementById('logoutBtn');
    const form = document.getElementById('contattiForm');

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    });

    function setupCallWhatsappButtons(phoneInputId, phoneBtnId, whatsappBtnId) {
      const phoneInput = document.getElementById(phoneInputId);
      const phoneBtn = document.getElementById(phoneBtnId);
      const whatsappBtn = document.getElementById(whatsappBtnId);

      phoneBtn.addEventListener('click', () => {
        if (!phoneInput.value.trim()) return alert("Numero non inserito");
        window.location.href = `tel:${phoneInput.value.trim()}`;
      });
      whatsappBtn.addEventListener('click', () => {
        if (!phoneInput.value.trim()) return alert("Numero non inserito");
        let num = phoneInput.value.replace(/\D/g,'');
        if(num.startsWith('0')) num = num.slice(1);
        window.open(`https://wa.me/${num}`, '_blank');
      });
    }

    function setupEmailWriteButton(emailInputId, emailBtnId) {
      const emailInput = document.getElementById(emailInputId);
      const emailBtn = document.getElementById(emailBtnId);
      emailBtn.addEventListener('click', () => {
        if (!emailInput.value.trim()) return alert("Email non inserita");
        window.location.href = `mailto:${emailInput.value.trim()}`;
      });
    }

    setupCallWhatsappButtons('genitore1_telefono', 'gen1_phone_btn', 'gen1_whatsapp_btn');
    setupCallWhatsappButtons('genitore2_telefono', 'gen2_phone_btn', 'gen2_whatsapp_btn');
    setupCallWhatsappButtons('esploratore_telefono', 'expl_phone_btn', 'expl_whatsapp_btn');

    setupEmailWriteButton('genitore1_email', 'gen1_email_write_btn');
    setupEmailWriteButton('genitore2_email', 'gen2_email_write_btn');
    setupEmailWriteButton('esploratore_email', 'expl_email_write_btn');

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'login.html';

      const uidParam = new URLSearchParams(window.location.search).get('uid') || user.uid;

      const userRef = doc(db, "utenti", user.uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        alert("Utente non trovato.");
        return window.location.href = 'login.html';
      }
      const currentUser = userSnap.data();

      if (currentUser.ruolo !== "staff" && uidParam !== user.uid) {
        alert("Accesso negato");
        return window.location.href = 'login.html';
      }

      const targetRef = doc(db, "utenti", uidParam);
      const targetSnap = await getDoc(targetRef);
      if (!targetSnap.exists()) {
        alert("Scheda utente non trovata.");
        return;
      }
      const scheda = targetSnap.data();

      form['genitore1_nome'].value = scheda.dati
