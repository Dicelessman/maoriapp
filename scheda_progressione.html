<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scheda Progressione</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; background: #f8f8f8; }
    h2 { color: #004b23; }
    .traccia { border: 1px solid #ccc; padding: 1em; margin-bottom: 2em; border-radius: 8px; background: white; }
    .direzione { margin-top: 1em; }
    .sfida { display: flex; align-items: center; margin-bottom: 0.5em; }
    .sfida input[type="checkbox"] { margin-right: 0.5em; }
    .sfida label { flex-grow: 1; }
    .sfida input[type="date"] { margin-left: 0.5em; }
    textarea { width: 100%; min-height: 4em; margin-top: 0.5em; }
    button { margin-top: 1em; padding: 0.5em 1em; font-size: 1em; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBx-VWjsz6GqNu8k8EHTMT5K3ZHZSpTtN8",
      authDomain: "repartapp.firebaseapp.com",
      projectId: "repartapp",
      storageBucket: "repartapp.appspot.com",
      messagingSenderId: "499657225189",
      appId: "1:499657225189:web:fe4c6f1fe8cf2aa026d097"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const promessaInput = document.getElementById("promessa");
    const ruoloInputs = document.getElementsByName("ruolo");
    const giglioInput = document.getElementById("giglio");
    const noteGiglioInput = document.getElementById("noteGiglio");
    const progressioneContainer = document.getElementById("progressioneContainer");
    const saveBtn = document.getElementById("saveBtn");

    let dati = {};

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Devi essere loggato per accedere a questa pagina.");
        window.location.href = "login.html";
        return;
      }

      const docRef = doc(db, "esploratori", user.uid);
      const snap = await getDoc(docRef);

      if (snap.exists()) {
        dati = snap.data().progressione || {};
      } else {
        dati = {};
      }

      inizializzaCampi();
      renderTracce();
    });

    function inizializzaCampi() {
      promessaInput.value = dati.promessa || "";
      giglioInput.value = dati.giglio || "";
      noteGiglioInput.value = dati.noteGiglio || "";
      ruoloInputs.forEach(r => { if (r.value === dati.ruolo) r.checked = true; });
    }

    function renderTracce() {
      progressioneContainer.innerHTML = "";
      if (!dati.tracce) return;
      dati.tracce.forEach((traccia, tracciaIndex) => {
        const tracciaDiv = document.createElement("div");
        tracciaDiv.className = "traccia";

        const titolo = document.createElement("h3");
        titolo.textContent = traccia.nome;
        tracciaDiv.appendChild(titolo);

        for (const direzione in traccia.direzioni) {
          const dirDiv = document.createElement("div");
          dirDiv.className = "direzione";

          const dirTitle = document.createElement("h4");
          dirTitle.textContent = direzione;
          dirDiv.appendChild(dirTitle);

          traccia.direzioni[direzione].forEach((sfida, sfidaIndex) => {
            const sfidaDiv = document.createElement("div");
            sfidaDiv.className = "sfida";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = sfida.completata;
            checkbox.addEventListener("change", () => {
              sfida.completata = checkbox.checked;
              dateInput.disabled = !checkbox.checked;
            });

            const label = document.createElement("label");
            label.textContent = `${sfida.codice} - ${sfida.descrizione}`;

            const dateInput = document.createElement("input");
            dateInput.type = "date";
            dateInput.value = sfida.data;
            dateInput.disabled = !sfida.completata;
            dateInput.addEventListener("input", () => {
              sfida.data = dateInput.value;
            });

            sfidaDiv.appendChild(checkbox);
            sfidaDiv.appendChild(label);
            sfidaDiv.appendChild(dateInput);
            dirDiv.appendChild(sfidaDiv);
          });

          tracciaDiv.appendChild(dirDiv);
        }

        const noteLabel = document.createElement("label");
        noteLabel.textContent = "Note:";
        noteLabel.style.display = "block";
        noteLabel.style.marginTop = "1em";

        const noteTextarea = document.createElement("textarea");
        noteTextarea.value = traccia.note;
        noteTextarea.addEventListener("input", () => {
          traccia.note = noteTextarea.value;
        });

        tracciaDiv.appendChild(noteLabel);
        tracciaDiv.appendChild(noteTextarea);

        progressioneContainer.appendChild(tracciaDiv);
      });
    }

    saveBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;

      dati.promessa = promessaInput.value;
      dati.giglio = giglioInput.value;
      dati.noteGiglio = noteGiglioInput.value;
      dati.ruolo = [...ruoloInputs].find(r => r.checked)?.value || "";

      const docRef = doc(db, "esploratori", user.uid);
      await setDoc(docRef, { progressione: dati }, { merge: true });
      alert("Progressione salvata correttamente.");
    });
  </script>
</head>
<body>
  <h2>Progressione Scout</h2>
  <div>
    <label>Promessa: <input type="date" id="promessa"></label><br>
    <label>Ruolo:
      <input type="radio" name="ruolo" value="VCP"> VCP
      <input type="radio" name="ruolo" value="CP"> CP
    </label><br>
    <label>Giglio/Trifoglio: <input type="date" id="giglio"></label><br>
    <label>Note Giglio/Trifoglio: <textarea id="noteGiglio"></textarea></label>
  </div>
  <div id="progressioneContainer"></div>
  <button id="saveBtn">Salva</button>
</body>
</html>
